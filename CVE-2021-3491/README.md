## 											CVE-2021-3491

### Where is the vuln

​	在`io_uring`中，`ddf0322db79c5984dc1a1db890f946dd19b7d6d9`commit新支持的*io_uring: add IORING_OP_PROVIDE_BUFFERS*。

​	大概的功能是用户可以注册一个buffer池，用于kernel处理op，对于标记了*IOSQE_BUFFER_SELECT* 的`op`，提交op时不需要预先分配内存，而是在IO就绪时，从buffer group里取出一个buffer（自动获取buffer）。可以避免大量未就绪的io预先分配了大量buffer造成内存开销。[io_uring support for automatic buffers](https://lwn.net/Articles/810414/)描述了该功能的支持原因。



### IORING_OP_PROVIDE_BUFFERS

注册的buffer池由group管理，每一个buffer有一个buffer id `bid`，当提交的`request`，flag置了`IOSQE_BUFFER_SELECT`，并指定了buffer池的group ID，当该request完成后，CEQ中返回对应的`bid`。



### More Deeper

对比引入该漏洞的[commit](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ddf0322db79c5984dc1a1db890f946dd19b7d6d9)，和修复该漏洞的[commit](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=d1f82808877bb10d3deee7cf3374a4eb3fb582db)，发现问题出现在`io_add_buffers`

```c
+static int io_add_buffers(struct io_provide_buf *pbuf, struct io_buffer **head)
+{
+	struct io_buffer *buf;				[1]
+	u64 addr = pbuf->addr;
+	int i, bid = pbuf->bid;
+
+	for (i = 0; i < pbuf->nbufs; i++) {
+		buf = kmalloc(sizeof(*buf), GFP_KERNEL);
+		if (!buf)
+			break;
+
+		buf->addr = addr;
+		buf->len = pbuf->len;			[2]
+		buf->bid = bid;
+		addr += pbuf->len;
+		bid++;
+		if (!*head) {
+			INIT_LIST_HEAD(&buf->list);
+			*head = buf;
+		} else {
+			list_add_tail(&buf->list, &(*head)->list);
+		}
+	}
+
+	return i ? i : -ENOMEM;
+}
+
```

在[2]处的一个赋值操作，`buf`的类型是`struct io_buffer`，`pbuf`的类型是`io_provide_buf`

```c
+struct io_provide_buf {
+	struct file			*file;
+	__u64				addr;
+	__s32				len;
+	__u32				bgid;
+	__u16				nbufs;
+	__u16				bid;
+};

struct io_buffer {
 	struct list_head list;
 	__u64 addr;
	__s32 len;
 	__u16 bid;
 };
 
```

两个结构体的`len`字段都是`__s32`即有符号整数，且没有设置`MAX_RW_COUNT `的限制，

`fs/read_write.c`下的`vfs_read/vfs_read`函数对于一次read/write操作有一个上限`MAX_RW_COUNT`

```c
	if (count > MAX_RW_COUNT)
		count =  MAX_RW_COUNT;
```



















### Refer

* https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3491
* https://vizee.org/2021/07/02/implement-echo-server-using-io-uring/
* https://lwn.net/Articles/813311/